# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**rcomm** is a multi-threaded HTTP web server written in Rust (edition 2024) from scratch with no external dependencies. It serves static HTML, CSS, and JavaScript files using a convention-based routing system derived from the `pages/` directory structure.

## Build & Run Commands

```bash
cargo build              # Build the project
cargo run                # Run the server (binds to 127.0.0.1:7879)
cargo test               # Run all tests (34 tests across lib + models)
cargo test <test_name>   # Run a single test by name
cargo test -- --nocapture # Run tests with println! output visible
```

## Architecture

### Core Components

1. **Thread Pool** (`src/lib.rs`) - Custom thread pool using `mpsc` channels and `Arc<Mutex<Receiver>>` for work distribution. Default 4 workers, graceful shutdown via Drop trait.

2. **HTTP Models** (`src/models/`) - Hand-rolled HTTP request/response parsing and serialization:
   - `http_methods.rs` - HTTP verb enum (uppercase only, e.g. "GET" parses but "get" does not)
   - `http_request.rs` - Request struct with TCP stream parser (`build_from_stream()`)
   - `http_response.rs` - Response struct with auto Content-Length on `add_body()`
   - `http_status_codes.rs` - Status code to phrase mapping

3. **Main Server** (`src/main.rs`) - TCP listener loop that dispatches connections to thread pool. Contains route building logic (`build_routes()`) and connection handler.

### Request/Response Pattern

Both `HttpRequest` and `HttpResponse` use a builder pattern with methods returning `&mut Self`. Note: `build()` returns an owned value, so chain after a `let mut` binding:
```rust
let mut response = HttpResponse::build(String::from("HTTP/1.1"), 200);
response.add_header("Content-Type".to_string(), "text/html".to_string());
response.add_body(content.into());
```

Headers are stored lowercase internally. `as_bytes()` serializes the full HTTP message (headers + body).

### Convention-Based Routing

Routes are auto-generated by recursively scanning `pages/` directory:
- `pages/index.html` → `/`
- `pages/howdy/page.html` → `/howdy`
- `pages/howdy/page.css` → `/howdy/page.css`
- `pages/not_found.html` → Used for 404 responses (not routed)

Pattern: Files named `index.html` or `page.html` become routes at their directory's path level. Other `.html`/`.css`/`.js` files are routed by their full relative path.

## Known Issues

- Extensive use of `.unwrap()` - no graceful error handling in routing/file serving
- Port/address hardcoded (127.0.0.1:7879)
